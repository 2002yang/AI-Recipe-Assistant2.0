# 美食推荐系统 - 推荐链条详解

## 概述

本系统采用 **LangChain + RAG (Retrieval-Augmented Generation)** 架构，结合向量语义搜索和传统匹配算法，提供智能菜谱推荐服务。

---

## 推荐流程架构图

```
用户输入
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│                    chat.py (API 路由)                        │
│  1. 创建/获取对话 ID                                          │
│  2. 获取对话历史上下文                                         │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│              langchain_nlp_service                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  parse_user_intent() - 意图解析                      │    │
│  │  • 使用 LangChain LLM + LCEL                        │    │
│  │  • 提取: 意图、食材、饮食限制、目标菜品                 │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│              意图判断 & 菜谱搜索                               │
│                                                             │
│  IF intent == "recommend_by_ingredients"                    │
│     │                                                      │
│     ├──▶ search_recipes_with_rag()                         │
│     │         │                                            │
│     │         ▼                                            │
│     │    ┌────────────────────────────┐                     │
│     │    │    vector_store.search()   │  ← 语义向量搜索      │
│     │    │  (ChromaDB 向量数据库)     │                     │
│     │    └────────────────────────────┘                     │
│     │         │                                            │
│     │         ▼                                            │
│     │    ┌────────────────────────────┐                     │
│     │    │  _check_restrictions()    │  ← 饮食限制过滤      │
│     │    │  素食/无海鲜/无辣/低碳水   │                     │
│     │    └────────────────────────────┘                     │
│     │         │                                            │
│     │         ▼                                            │
│     │    ┌────────────────────────────┐                     │
│     │    │  计算食材匹配得分           │                     │
│     │    │  matched_ingredients       │                     │
│     │    └────────────────────────────┘                     │
│     │                                                      │
│     ELSE IF intent == "nutrition_query"                    │
│     │    └──▶ recipe_matcher.py (传统搜索)                  │
│     │                                                      │
│     ELSE (一般对话)                                         │
│          └──▶ 直接进入回复生成                                │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│              langchain_nlp_service                          │
│  ┌─────────────────────────────────────────────────────┐     │
│  │  generate_response() - 生成回复                      │     │
│  │  • 使用 LangChain LCEL Chain                        │     │
│  │  • 结合对话历史 + 推荐菜谱信息                        │     │
│  │  • DeepSeek API 生成自然语言回复                     │     │
│  └─────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│              enhanced_conversation_manager                   │
│  • 保存对话历史到 ChatMessageHistory                         │
│  • 更新检测到的食材和饮食限制                                  │
│  • 维护对话上下文                                             │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
返回 Response {
    message: "AI 回复文本",
    conversation_id: "会话ID",
    suggested_recipes: [推荐菜谱列表],
    detected_ingredients: [识别到的食材],
    detected_restrictions: [饮食限制]
}
```

---

## 核心组件详解

### 1. 意图解析 (langchain_nlp.py)

```python
parsed_intent = await langchain_nlp_service.parse_user_intent(message)
```

**使用 LangChain LCEL 管道：**
```
PromptTemplate → ChatOpenAI (deepseek-chat) → JsonOutputParser
```

**输出结构：**
```json
{
    "intent": "recommend_by_ingredients",
    "ingredients": ["番茄", "鸡蛋"],
    "restrictions": ["素食"],
    "preferences": [],
    "target_dish": "",
    "question_type": "食材推荐"
}
```

### 2. RAG 语义搜索 (langchain_nlp.py)

```python
rag_results = await langchain_nlp_service.search_recipes_with_rag(
    query=message,
    ingredients=ingredients,
    restrictions=restrictions,
    top_k=5
)
```

**搜索流程：**
1. **构建查询** → `f"包含番茄、鸡蛋的菜"`
2. **向量搜索** → `vector_store.search(query, n_results=10)`
3. **限制过滤** → `_check_restrictions(recipe, restrictions)`
4. **食材匹配** → 计算用户食材与菜谱食材的重叠
5. **排序返回** → 按 match_score 降序

### 3. 向量数据库 (vector_store.py)

**使用 ChromaDB 存储菜谱向量：**

| 字段 | 说明 |
|------|------|
| id | 菜谱ID |
| document | 菜谱文本描述 |
| embedding | 384维向量 (简单hash方法) |
| metadata | name, category, tags, ingredients等 |

**搜索方法：**
```python
# 生成查询向量
query_embedding = embedding_service.embed_text(query)

# ChromaDB 相似度搜索
results = collection.query(
    query_embeddings=[query_embedding],
    n_results=n_results,
    include=["metadatas", "documents", "distances"]
)

# 余弦相似度计算
similarity = 1 - distance
```

### 4. 回复生成 (langchain_nlp.py)

```python
ai_response = await langchain_nlp_service.generate_response(
    user_message=message,
    history=context,
    recipes=suggested_recipes
)
```

**使用 LangChain LCEL：**
```
ChatPromptTemplate → ChatOpenAI (deepseek-chat) → StrOutputParser
```

**System Prompt 包含：**
- 角色设定（美食助手）
- 对话历史 (最近5轮)
- 推荐菜谱信息

### 5. 对话管理 (enhanced_conversation_manager.py)

```python
# 保存用户消息
enhanced_conversation_manager.add_message(
    conversation_id=conversation_id,
    role="user",
    content=message,
    ingredients=ingredients,
    restrictions=restrictions
)

# 获取上下文
context = enhanced_conversation_manager.get_recent_context(conversation_id)
```

**使用 LangChain ChatMessageHistory：**
- 持久化存储对话消息
- 支持多轮对话上下文
- 跟踪用户食材和饮食偏好

---

## 技术栈

| 组件 | 技术 |
|------|------|
| 后端框架 | FastAPI |
| LLM | DeepSeek Chat (API) |
| 向量数据库 | ChromaDB |
| Embedding | 本地简单hash方法 (384维) |
| 对话管理 | LangChain ChatMessageHistory |
| Chain构建 | LangChain LCEL |
| 菜谱数据 | JSON文件 (50道菜谱) |

---

## API 调用示例

### 1. 创建对话
```bash
POST /api/chat/new
Response: {"conversation_id": "xxx", "message": "新对话已创建..."}
```

### 2. 发送消息
```bash
POST /api/chat/message
{
    "message": "我家里有番茄、鸡蛋，能做什么？",
    "conversation_id": "xxx"
}

Response: {
    "message": "根据您有的食材，我推荐...",
    "conversation_id": "xxx",
    "suggested_recipes": [
        {
            "recipe": {...},
            "match_score": 0.85,
            "matched_ingredients": ["番茄", "鸡蛋"],
            "missing_ingredients": ["葱", "盐"]
        }
    ],
    "detected_ingredients": ["番茄", "鸡蛋"],
    "detected_restrictions": []
}
```

### 3. 语义搜索 (直接RAG)
```bash
POST /api/chat/search?query=素食快手菜&top_k=3
```

---

## 文件位置

```
backend/app/
├── main.py                          # FastAPI 入口
├── routers/
│   └── chat.py                     # 对话 API 路由
├── services/
│   ├── langchain_nlp.py            # LangChain NLP 服务
│   │   ├── parse_user_intent()    # 意图解析
│   │   ├── search_recipes_with_rag()  # RAG 搜索
│   │   └── generate_response()    # 回复生成
│   ├── vector_store.py             # ChromaDB 向量库
│   │   ├── search()               # 向量搜索
│   │   └── add_recipes()          # 添加菜谱
│   ├── embedding_service.py        # 向量化服务
│   ├── enhanced_conversation.py   # 对话管理
│   │   ├── add_message()          # 添加消息
│   │   └── get_recent_context()  # 获取上下文
│   └── recipe_matcher.py          # 传统匹配算法
└── data/
    └── recipes.json                # 50道菜谱数据
```

---

## 升级记录

- **v1.0**: 基础版本，使用 TF-IDF + 余弦相似度
- **v2.0 (当前)**: LangChain + RAG，使用 ChromaDB 向量搜索

---

*最后更新: 2026-02-23*
